{% extends "base.html" %}

{% block page_vars %}
    {% set barcode_mode = 'auto' %}
    {% set label_barcode_endpoint = url_for('scanning.label_barcode_scan') %}
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h2 class="mb-1"><i class="bi bi-speedometer2 me-2"></i>Centrum Dowodzenia</h2>
            <p class="text-muted mb-0">Witaj, {{ username }}! Oto przegląd Twojego sklepu.</p>
        </div>
        <div class="text-muted">
            <i class="bi bi-clock me-1"></i>{{ now().strftime('%d.%m.%Y %H:%M') }}
        </div>
    </div>

    <!-- Quick Actions Bar -->
    <div class="d-flex flex-wrap gap-2 mb-4">
        <a href="{{ url_for('products.items') }}" class="btn btn-primary">
            <i class="bi bi-box me-1"></i>Produkty
        </a>
        <a href="{{ url_for('orders.orders_list') }}" class="btn btn-success">
            <i class="bi bi-receipt me-1"></i>Zamówienia
        </a>
        <a href="{{ url_for('products.import_invoice') }}" class="btn btn-info">
            <i class="bi bi-file-earmark-plus me-1"></i>Import faktury
        </a>
        <a href="{{ url_for('scanning.barcode_scan_page', next=url_for('home')) }}" class="btn btn-secondary">
            <i class="bi bi-upc-scan me-1"></i>Skanuj kod
        </a>
        <a href="{{ url_for('allegro.offers_and_prices') }}" class="btn btn-warning">
            <i class="bi bi-shop me-1"></i>Allegro
        </a>
    </div>

    <!-- Quick Stats Cards Row -->
    <div class="row g-3 mb-4">
        <!-- Orders Today -->
        <div class="col-6 col-md-3">
            <div class="card bg-success text-white h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="card-subtitle mb-2 opacity-75">Zamówienia dziś</h6>
                            <h2 class="card-title mb-0">{{ dashboard.orders.today }}</h2>
                        </div>
                        <i class="bi bi-cart-check fs-1 opacity-50"></i>
                    </div>
                </div>
                <div class="card-footer bg-transparent border-0 pt-0">
                    <small><i class="bi bi-calendar-week me-1"></i>Tydzień: {{ dashboard.orders.week }}</small>
                </div>
            </div>
        </div>

        <!-- Revenue Today -->
        <div class="col-6 col-md-3">
            <div class="card bg-primary text-white h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="card-subtitle mb-2 opacity-75">Przychód dziś</h6>
                            <h2 class="card-title mb-0">{{ "%.0f"|format(dashboard.revenue.today) }} zł</h2>
                        </div>
                        <i class="bi bi-cash-stack fs-1 opacity-50"></i>
                    </div>
                </div>
                <div class="card-footer bg-transparent border-0 pt-0">
                    <small><i class="bi bi-calendar-week me-1"></i>Tydzień: {{ "%.0f"|format(dashboard.revenue.week) }} zł</small>
                </div>
            </div>
        </div>

        <!-- Pending Orders -->
        <div class="col-6 col-md-3">
            <div class="card {% if dashboard.orders.pending > 0 %}bg-warning text-dark{% else %}bg-secondary text-white{% endif %} h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="card-subtitle mb-2 opacity-75">Do wysłania</h6>
                            <h2 class="card-title mb-0">{{ dashboard.orders.pending }}</h2>
                        </div>
                        <i class="bi bi-box-seam fs-1 opacity-50"></i>
                    </div>
                </div>
                <div class="card-footer bg-transparent border-0 pt-0">
                    <a href="{{ url_for('orders.orders_list') }}" class="{% if dashboard.orders.pending > 0 %}text-dark{% else %}text-white{% endif %} text-decoration-none">
                        <small><i class="bi bi-arrow-right me-1"></i>Zobacz zamówienia</small>
                    </a>
                </div>
            </div>
        </div>

        <!-- Inventory Status -->
        <div class="col-6 col-md-3">
            <div class="card bg-info text-white h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="card-subtitle mb-2 opacity-75">Stan magazynu</h6>
                            <h2 class="card-title mb-0">{{ dashboard.inventory.total_stock }}</h2>
                        </div>
                        <i class="bi bi-archive fs-1 opacity-50"></i>
                    </div>
                </div>
                <div class="card-footer bg-transparent border-0 pt-0">
                    <small>
                        <i class="bi bi-exclamation-triangle me-1"></i>Brak: {{ dashboard.inventory.out_of_stock }}
                    </small>
                </div>
            </div>
        </div>
    </div>

    <!-- Second Row: Monthly Stats -->
    <div class="row g-3 mb-4">
        <div class="col-md-8">
            <div class="card h-100">
                <div class="card-header bg-dark text-white">
                    <i class="bi bi-graph-up me-2"></i>{{ dashboard.current_month_name }} {{ now().strftime('%Y') }}
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-3">
                            <div class="border-end">
                                <h3 class="text-success mb-1">{{ dashboard.orders.month }}</h3>
                                <small class="text-muted">Zamowien</small>
                            </div>
                        </div>
                        <div class="col-3">
                            <div class="border-end">
                                <h3 class="text-primary mb-1">{{ "%.0f"|format(dashboard.revenue.month) }} zl</h3>
                                <small class="text-muted">Przychod</small>
                            </div>
                        </div>
                        <div class="col-3" id="profit-section">
                            <div class="border-end">
                                <h3 class="text-muted mb-1"><span class="spinner-border spinner-border-sm"></span></h3>
                                <small class="text-muted">Realny zysk <i class="bi bi-info-circle"></i></small>
                            </div>
                        </div>
                        <div class="col-3" id="sold-section">
                            <div>
                                <h3 class="text-muted mb-1"><span class="spinner-border spinner-border-sm"></span></h3>
                                <small class="text-muted">Sprzedanych szt.</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card h-100">
                <div class="card-header bg-dark text-white">
                    <i class="bi bi-shop me-2"></i>Allegro
                    <span class="badge bg-success float-end ms-1">{{ dashboard.allegro.total_offers }} ofert</span>
                </div>
                <div class="card-body p-2">
                    <!-- Statystyki ofert -->
                    <div class="d-flex justify-content-between align-items-center mb-1 px-1">
                        <small>Aktywne oferty:</small>
                        <span class="badge bg-success">{{ dashboard.allegro.total_offers }}</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center px-1">
                        <small>Niepowiazane:</small>
                        <span class="badge {% if dashboard.allegro.unlinked_offers > 0 %}bg-warning text-dark{% else %}bg-secondary{% endif %}">
                            {{ dashboard.allegro.unlinked_offers }}
                        </span>
                    </div>
                    {% if dashboard.allegro.unlinked_offers > 0 %}
                    <div class="px-1 mt-1">
                        <a href="{{ url_for('allegro.offers_and_prices') }}" class="btn btn-outline-warning btn-sm w-100">
                            <i class="bi bi-link me-1"></i>Powiaz oferty
                        </a>
                    </div>
                    {% endif %}
                    
                    <!-- Wyroznienia - ladowane asynchronicznie -->
                    <div id="promotions-section">
                        <hr class="my-2">
                        <div class="text-center py-2">
                            <span class="spinner-border spinner-border-sm text-muted"></span>
                            <small class="text-muted ms-1">Ladowanie wyroznien...</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Row -->
    <div class="row g-3">
        <!-- Left Column: Activity Feed -->
        <div class="col-lg-4">
            <div class="card h-100">
                <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-activity me-2"></i>Ostatnia aktywność</span>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush" style="max-height: 320px; overflow-y: auto;">
                        {% for activity in dashboard.activities %}
                        <a href="{{ activity.link }}" class="list-group-item list-group-item-action py-2">
                            <div class="d-flex align-items-start">
                                <div class="me-2">
                                    <span class="badge bg-{{ activity.color }} rounded-circle p-2">
                                        <i class="bi {{ activity.icon }}"></i>
                                    </span>
                                </div>
                                <div class="flex-grow-1">
                                    <div class="d-flex justify-content-between">
                                        <strong class="small">{{ activity.title }}</strong>
                                        <small class="text-muted">{{ activity.timestamp.strftime('%H:%M') }}</small>
                                    </div>
                                    <small class="text-muted">{{ activity.description|truncate(50) }}</small>
                                </div>
                            </div>
                        </a>
                        {% else %}
                        <div class="list-group-item text-center text-muted py-4">
                            <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                            Brak ostatniej aktywności
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Middle Column: Latest Orders -->
        <div class="col-lg-5">
            <div class="card h-100">
                <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-receipt me-2"></i>Ostatnie zamówienia</span>
                    <a href="{{ url_for('orders.orders_list') }}" class="btn btn-sm btn-outline-light">
                        Zobacz wszystkie
                    </a>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover table-sm mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>ID</th>
                                    <th>Klient</th>
                                    <th>Produkty</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for order in dashboard.latest_orders[:7] %}
                                <tr onclick="window.location='{{ url_for('orders.order_detail', order_id=order.order_id) }}'" style="cursor: pointer;">
                                    <td class="small">
                                        <code>{{ order.order_id[-6:] }}</code>
                                    </td>
                                    <td class="small">{{ (order.customer_name or 'Brak')|truncate(20) }}</td>
                                    <td class="small">
                                        {% if order.products_count %}
                                            {{ order.products_count }} szt.
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if order.delivery_package_nr %}
                                            <span class="badge bg-success"><i class="bi bi-check"></i></span>
                                        {% else %}
                                            <span class="badge bg-warning text-dark"><i class="bi bi-clock"></i></span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="4" class="text-center text-muted py-4">
                                        Brak zamówień
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column: Low Stock Alert + Quick Actions -->
        <div class="col-lg-3">
            <!-- Low Stock Alert -->
            <div class="card mb-3">
                <div class="card-header bg-danger text-white">
                    <i class="bi bi-exclamation-triangle me-2"></i>Niski stan magazynu
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush" style="max-height: 200px; overflow-y: auto;">
                        {% for item in dashboard.inventory.low_stock_items %}
                        <a href="{{ url_for('products.product_detail', product_id=item.product_id) }}" 
                           class="list-group-item list-group-item-action d-flex justify-content-between align-items-center py-2">
                            <div class="small">
                                <div class="fw-semibold">{{ item.product_name|truncate(25) }}</div>
                                <small class="text-muted">{{ item.product_color or '' }} / {{ item.size }}</small>
                            </div>
                            <span class="badge bg-danger rounded-pill">{{ item.quantity }}</span>
                        </a>
                        {% else %}
                        <div class="list-group-item text-center text-muted py-3">
                            <i class="bi bi-check-circle text-success fs-4 d-block mb-1"></i>
                            <small>Wszystko w porządku!</small>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Latest Deliveries Row - Zgrupowane dostawy z rozwijaniem -->
    {% if dashboard.latest_deliveries %}
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <i class="bi bi-truck me-2"></i>Ostatnie dostawy
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-sm table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 40px;"></th>
                                    <th>Data</th>
                                    <th>Dostawca / Zrodlo</th>
                                    <th>Faktura</th>
                                    <th class="text-center">Pozycje</th>
                                    <th class="text-center">Laczna ilosc</th>
                                    <th class="text-end">Wartosc</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for delivery in dashboard.latest_deliveries %}
                                <tr class="delivery-row" data-bs-toggle="collapse" data-bs-target="#delivery-{{ loop.index }}" 
                                    aria-expanded="false" aria-controls="delivery-{{ loop.index }}" 
                                    style="cursor: pointer;">
                                    <td class="text-center">
                                        <i class="bi bi-chevron-right delivery-chevron"></i>
                                    </td>
                                    <td class="small fw-semibold">{{ delivery.purchase_date }}</td>
                                    <td>
                                        <span class="fw-semibold">{{ delivery.supplier or 'Import z Excela' }}</span>
                                    </td>
                                    <td class="small text-muted">{{ delivery.invoice_number or '-' }}</td>
                                    <td class="text-center">
                                        <span class="badge bg-secondary">{{ delivery.products|length }} poz.</span>
                                    </td>
                                    <td class="text-center">
                                        <span class="badge bg-info">{{ delivery.total_quantity }} szt.</span>
                                    </td>
                                    <td class="text-end text-success fw-semibold">{{ "%.2f"|format(delivery.total_value) }} zl</td>
                                </tr>
                                <tr class="collapse" id="delivery-{{ loop.index }}">
                                    <td colspan="7" class="p-0 bg-light">
                                        <div class="p-2">
                                            <table class="table table-sm table-bordered mb-0 bg-white">
                                                <thead class="table-secondary">
                                                    <tr>
                                                        <th>Produkt</th>
                                                        <th>Kolor</th>
                                                        <th>Rozmiar</th>
                                                        <th class="text-center">Ilosc</th>
                                                        <th class="text-end">Cena jedn.</th>
                                                        <th class="text-end">Wartosc</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for product in delivery.products %}
                                                    <tr>
                                                        <td class="small">
                                                            <a href="{{ url_for('products.product_detail', product_id=product.product_id) }}" class="text-decoration-none">
                                                                {{ product.name }}
                                                            </a>
                                                        </td>
                                                        <td class="small text-muted">{{ product.color or '-' }}</td>
                                                        <td class="small">{{ product.size }}</td>
                                                        <td class="text-center"><span class="badge bg-info">{{ product.quantity }}</span></td>
                                                        <td class="text-end small">{{ "%.2f"|format(product.price) }} zl</td>
                                                        <td class="text-end small text-success">{{ "%.2f"|format(product.value) }} zl</td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <style>
    .delivery-row:hover {
        background-color: #f8f9fa;
    }
    .delivery-row .delivery-chevron {
        transition: transform 0.2s ease;
    }
    .delivery-row[aria-expanded="true"] .delivery-chevron {
        transform: rotate(90deg);
    }
    </style>
    
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Obsluga animacji chevron przy rozwijaniu/zwijaniu
        document.querySelectorAll('.delivery-row').forEach(function(row) {
            row.addEventListener('click', function() {
                var expanded = this.getAttribute('aria-expanded') === 'true';
                this.setAttribute('aria-expanded', !expanded);
            });
        });
    });
    </script>
    {% endif %}

    <!-- ================================================================= -->
    <!-- TRENDY I BESTSELLERY - ladowane asynchronicznie -->
    <!-- ================================================================= -->
    
    <!-- Trend tygodniowy -->
    <div class="row mt-4 g-3" id="trends-section">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-gradient" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                    <i class="bi bi-graph-up-arrow me-2"></i>Trend tygodniowy (porownanie do poprzedniego tygodnia)
                </div>
                <div class="card-body text-center py-4">
                    <span class="spinner-border text-muted"></span>
                    <p class="text-muted mt-2 mb-0">Ladowanie trendow...</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bestsellery -->
    <div class="row mt-4 g-3" id="bestsellers-section">
        <div class="col-lg-4">
            <div class="card h-100">
                <div class="card-header bg-danger text-white">
                    <i class="bi bi-fire me-2"></i>Trendy tygodnia (Top 5)
                </div>
                <div class="card-body text-center py-4">
                    <span class="spinner-border spinner-border-sm text-muted"></span>
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card h-100">
                <div class="card-header bg-success text-white">
                    <i class="bi bi-trophy me-2"></i>Bestsellery miesiaca (Top 10)
                </div>
                <div class="card-body text-center py-4">
                    <span class="spinner-border spinner-border-sm text-muted"></span>
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card h-100">
                <div class="card-header bg-primary text-white">
                    <i class="bi bi-star-fill me-2"></i>Bestsellery wszechczasow
                </div>
                <div class="card-body text-center py-4">
                    <span class="spinner-border spinner-border-sm text-muted"></span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Produkty wolnoobrotowe -->
    <div id="slow-moving-section"></div>
</div>

<style>
/* Dashboard specific styles */
.card {
    border: none;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
}

.card-header {
    font-weight: 600;
}

.list-group-item {
    border-left: none;
    border-right: none;
}

.list-group-item:first-child {
    border-top: none;
}

/* Make stat cards more prominent */
.card.bg-success, .card.bg-primary, .card.bg-warning, .card.bg-info {
    border-radius: 0.5rem;
}

/* Activity feed timeline effect */
.list-group-item .badge.rounded-circle {
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* Hover effects */
.card:hover {
    box-shadow: 0 0.25rem 0.5rem rgba(0, 0, 0, 0.1);
    transition: box-shadow 0.15s ease-in-out;
}

/* Table row hover in cards */
.table-hover tbody tr:hover {
    background-color: rgba(0, 0, 0, 0.02);
}
</style>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Inicjalizacja tooltipow Bootstrap
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    // Initialize global barcode detector for label scanning on home page
    if (typeof GlobalBarcodeDetector !== 'undefined') {
        const detector = new GlobalBarcodeDetector({
            endpoint: '{{ label_barcode_endpoint }}',
            onSuccess: function(data) {
                window.location.reload();
            }
        });
    }
    
    // =============================================
    // Lazy loading ciezkich danych dashboardu
    // =============================================
    const ordersWeek = {{ dashboard.orders.week }};
    const revenueWeek = {{ "%.0f"|format(dashboard.revenue.week) }};
    
    fetch('/api/dashboard/heavy')
        .then(r => r.json())
        .then(data => {
            renderProfit(data.profit);
            renderPromotions(data.promotions);
            renderTrends(data.trends);
            renderBestsellers(data.bestsellers);
            renderSlowMoving(data.slow_moving);
        })
        .catch(err => {
            console.error('Blad ladowania danych:', err);
            document.getElementById('profit-section').querySelector('.border-end').innerHTML =
                '<h3 class="text-danger mb-1">Blad</h3><small class="text-muted">Realny zysk</small>';
        });
    
    function renderProfit(profit) {
        if (!profit) return;
        const color = profit.month > 0 ? 'text-success' : 'text-danger';
        
        let tooltip = `Zysk brutto: ${Math.round(profit.month_before_fixed + (profit.ads_cost || 0))} zl`;
        if (profit.ads_cost > 0) {
            tooltip += `<br>Koszty kampanii Ads: -${profit.ads_cost.toFixed(2)} zl`;
        }
        if (profit.returned_orders) {
            tooltip += `<br>Pominietych zwrotow: ${profit.returned_orders}`;
        }
        if (profit.fixed_costs_list && profit.fixed_costs_list.length > 0) {
            tooltip += `<br>Koszty stale: -${Math.round(profit.fixed_costs)} zl`;
            profit.fixed_costs_list.forEach(fc => {
                tooltip += `<br>&nbsp;&nbsp;- ${fc.name}: ${Math.round(fc.amount)} zl`;
            });
        }
        
        const profitEl = document.getElementById('profit-section');
        profitEl.querySelector('.border-end').setAttribute('data-bs-toggle', 'tooltip');
        profitEl.querySelector('.border-end').setAttribute('data-bs-placement', 'bottom');
        profitEl.querySelector('.border-end').setAttribute('data-bs-html', 'true');
        profitEl.querySelector('.border-end').setAttribute('title', tooltip);
        profitEl.querySelector('.border-end').innerHTML =
            `<h3 class="${color} mb-1">${Math.round(profit.month)} zl</h3>` +
            `<small class="text-muted">Realny zysk <i class="bi bi-info-circle"></i></small>`;
        
        const soldEl = document.getElementById('sold-section');
        soldEl.querySelector('div').innerHTML =
            `<h3 class="text-info mb-1">${profit.products_sold}</h3>` +
            `<small class="text-muted">Sprzedanych szt.</small>`;
        
        // Reinicjalizacja tooltipow
        new bootstrap.Tooltip(profitEl.querySelector('[data-bs-toggle="tooltip"]'));
    }
    
    function renderPromotions(promos) {
        const section = document.getElementById('promotions-section');
        if (!promos || promos.error) {
            section.innerHTML = '<hr class="my-2"><p class="text-muted text-center small mb-0">Brak danych wyroznien</p>';
            return;
        }
        
        // Dodaj badge z liczba do headera karty
        const cardHeader = section.closest('.card').querySelector('.card-header');
        const existingBadge = cardHeader.querySelector('.badge.bg-info');
        if (!existingBadge) {
            const badge = document.createElement('span');
            badge.className = 'badge bg-info float-end';
            badge.textContent = promos.active_count + ' wyroz.';
            cardHeader.appendChild(badge);
        }
        
        // Podswietl karte jesli jutro przedluzenie
        if (promos.renewing_tomorrow_count > 0) {
            const card = section.closest('.card');
            card.classList.add('border-warning');
            cardHeader.className = 'card-header bg-warning text-dark';
        }
        
        let html = '<hr class="my-2">';
        if (promos.active_promotions && promos.active_promotions.length > 0) {
            html += '<div class="table-responsive" style="max-height: 180px; overflow-y: auto;">';
            html += '<table class="table table-sm table-hover mb-0" style="font-size: 0.78rem;">';
            html += '<thead class="table-light sticky-top"><tr><th>Oferta</th><th class="text-center">Typ</th><th class="text-end">Koszt</th><th class="text-end">Przedl.</th></tr></thead><tbody>';
            
            promos.active_promotions.forEach(p => {
                const rowClass = (p.days_to_renewal !== null && p.days_to_renewal <= 1) ? 'table-warning' : '';
                let typeBadge = '';
                if (p.package_name) {
                    if (p.package_name.includes('10')) typeBadge = '<span class="badge bg-primary">10d</span>';
                    else if (p.package_name.toLowerCase().includes('elast')) typeBadge = '<span class="badge bg-success">1d</span>';
                    else if (p.package_name.toLowerCase().includes('dzia')) typeBadge = '<span class="badge bg-secondary">dzial</span>';
                    else typeBadge = `<span class="badge bg-secondary">${p.package_name.substring(0,8)}</span>`;
                }
                let renewal = '-';
                if (p.next_cycle_date) {
                    if (p.days_to_renewal !== null && p.days_to_renewal <= 1) renewal = `<span class="text-danger fw-bold">jutro</span>`;
                    else if (p.days_to_renewal !== null && p.days_to_renewal <= 3) renewal = `<span class="text-warning">${p.days_to_renewal}d</span>`;
                    else renewal = `<span class="text-muted">${p.next_cycle_date.substring(0,10)}</span>`;
                } else if (p.will_renew) {
                    renewal = '<span class="text-muted">auto</span>';
                }
                
                html += `<tr class="${rowClass}">`;
                html += `<td class="text-truncate" style="max-width: 120px;" title="${p.offer_name}"><a href="https://allegro.pl/oferta/${p.offer_id}" target="_blank" class="text-decoration-none">${p.offer_name}</a></td>`;
                html += `<td class="text-center text-nowrap">${typeBadge}</td>`;
                html += `<td class="text-end text-nowrap">${p.estimated_cost.toFixed(2)} zl</td>`;
                html += `<td class="text-end text-nowrap">${renewal}</td>`;
                html += '</tr>';
            });
            
            html += '</tbody></table></div>';
        } else {
            html += '<p class="text-muted text-center small mb-0">Brak aktywnych wyroznien</p>';
        }
        html += `<div class="d-flex justify-content-between align-items-center mt-1 px-1">`;
        html += `<small class="text-muted">Szac. mies.:</small>`;
        html += `<span class="badge bg-secondary">${promos.estimated_monthly_cost.toFixed(2)} zl</span></div>`;
        
        section.innerHTML = html;
    }
    
    function renderTrends(trends) {
        if (!trends) return;
        const section = document.getElementById('trends-section');
        const card = section.querySelector('.card-body');
        
        const ocArrow = trends.orders_change >= 0 ? '<i class="bi bi-arrow-up"></i>' : '<i class="bi bi-arrow-down"></i>';
        const ocColor = trends.orders_change >= 0 ? 'text-success' : 'text-danger';
        const rcArrow = trends.revenue_change >= 0 ? '<i class="bi bi-arrow-up"></i>' : '<i class="bi bi-arrow-down"></i>';
        const rcColor = trends.revenue_change >= 0 ? 'text-success' : 'text-danger';
        
        card.innerHTML = `
            <div class="row text-center">
                <div class="col-md-6">
                    <h5 class="mb-1">Zamowienia</h5>
                    <h3 class="mb-0">${ordersWeek} <small class="${ocColor}">${ocArrow} ${trends.orders_change}%</small></h3>
                    <small class="text-muted">poprzedni tydzien: ${trends.prev_week_orders}</small>
                </div>
                <div class="col-md-6">
                    <h5 class="mb-1">Przychod</h5>
                    <h3 class="mb-0">${revenueWeek} zl <small class="${rcColor}">${rcArrow} ${trends.revenue_change}%</small></h3>
                    <small class="text-muted">poprzedni tydzien: ${Math.round(trends.prev_week_revenue)} zl</small>
                </div>
            </div>
        `;
    }
    
    function renderBestsellerTable(items, badgeColor) {
        if (!items || items.length === 0) {
            return '<tr><td colspan="4" class="text-center text-muted py-3">Brak danych</td></tr>';
        }
        return items.map((item, i) => {
            const idx = i + 1;
            let numBadge;
            if (idx === 1) numBadge = '<span class="badge bg-warning text-dark">1</span>';
            else if (idx === 2) numBadge = '<span class="badge bg-secondary">2</span>';
            else if (idx === 3) numBadge = '<span class="badge bg-dark">3</span>';
            else numBadge = `<span class="text-muted">${idx}</span>`;
            
            const nameHtml = item.product_id
                ? `<a href="/products/${item.product_id}" class="text-decoration-none" title="${item.name}">${item.short_name}</a>`
                : `<span title="${item.name}">${item.short_name}</span>`;
            
            const revCol = item.revenue !== undefined ? `<td class="text-end small text-success fw-semibold">${Math.round(item.revenue)} zl</td>` : '';
            
            return `<tr><td>${numBadge}</td><td class="small">${nameHtml}</td><td class="text-center"><span class="badge bg-${badgeColor}">${item.quantity}</span></td>${revCol}</tr>`;
        }).join('');
    }
    
    function renderBestsellers(bestsellers) {
        if (!bestsellers) return;
        const section = document.getElementById('bestsellers-section');
        const cards = section.querySelectorAll('.card');
        
        // Trendy tygodnia
        const weekCols = '<tr><th>#</th><th>Produkt</th><th class="text-center">Szt.</th></tr>';
        cards[0].querySelector('.card-body').innerHTML =
            `<div class="table-responsive"><table class="table table-sm table-hover mb-0"><thead class="table-light">${weekCols}</thead><tbody>${renderBestsellerTable(bestsellers.week, 'danger')}</tbody></table></div>`;
        
        // Miesiaca
        const monthCols = '<tr><th>#</th><th>Produkt</th><th class="text-center">Szt.</th><th class="text-end">Przychod</th></tr>';
        cards[1].querySelector('.card-body').innerHTML =
            `<div class="table-responsive" style="max-height: 300px; overflow-y: auto;"><table class="table table-sm table-hover mb-0"><thead class="table-light sticky-top">${monthCols}</thead><tbody>${renderBestsellerTable(bestsellers.month, 'success')}</tbody></table></div>`;
        
        // Wszechczasow
        cards[2].querySelector('.card-body').innerHTML =
            `<div class="table-responsive" style="max-height: 300px; overflow-y: auto;"><table class="table table-sm table-hover mb-0"><thead class="table-light sticky-top">${monthCols}</thead><tbody>${renderBestsellerTable(bestsellers.all_time, 'primary')}</tbody></table></div>`;
    }
    
    function renderSlowMoving(items) {
        if (!items || items.length === 0) return;
        const section = document.getElementById('slow-moving-section');
        
        let rows = items.map(item => {
            let rotation = item.sold_30d > 0 ? (item.stock / item.sold_30d) * 30 : 9999;
            let rotBadge;
            if (rotation > 180) rotBadge = `<span class="badge bg-danger">${Math.round(rotation)} dni</span>`;
            else if (rotation > 90) rotBadge = `<span class="badge bg-warning text-dark">${Math.round(rotation)} dni</span>`;
            else rotBadge = `<span class="badge bg-secondary">${Math.round(rotation)} dni</span>`;
            
            return `<tr>
                <td>${(item.name || '').substring(0, 40)}</td>
                <td class="small text-muted">${item.color || '-'}</td>
                <td>${item.size}</td>
                <td class="text-center"><span class="badge bg-info">${item.stock}</span></td>
                <td class="text-center"><span class="badge bg-danger">${item.sold_30d}</span></td>
                <td class="text-center">${rotBadge}</td>
            </tr>`;
        }).join('');
        
        section.innerHTML = `
        <div class="row mt-4">
            <div class="col-12">
                <div class="card border-warning">
                    <div class="card-header bg-warning text-dark">
                        <i class="bi bi-exclamation-triangle me-2"></i>Produkty wolnoobrotowe - rozwaz promocje
                        <small class="float-end">(stan >= 5 szt., sprzedaz < 2 szt. w 30 dni)</small>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-sm table-hover mb-0">
                                <thead class="table-light">
                                    <tr><th>Produkt</th><th>Kolor</th><th>Rozmiar</th><th class="text-center">Stan</th><th class="text-center">Sprzedaz 30d</th><th class="text-center">Rotacja</th></tr>
                                </thead>
                                <tbody>${rows}</tbody>
                            </table>
                        </div>
                    </div>
                    <div class="card-footer bg-light">
                        <small class="text-muted">
                            <i class="bi bi-info-circle me-1"></i>
                            Rotacja = szacowany czas wyprzedania przy aktualnym tempie sprzedazy. 
                            Produkty z rotacja > 180 dni powinny byc objete promocja lub wyprzedaza.
                        </small>
                    </div>
                </div>
            </div>
        </div>`;
    }
});
</script>
{% endblock %}
