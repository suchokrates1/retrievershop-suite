{% extends "base.html" %}
{% block page_vars %}
{% set full_width = True %}
{% endblock %}
{% block content %}
<div class="container-fluid">
    {# Header with back button and order ID #}
    <div class="row mb-4">
        <div class="col">
            <a href="{{ url_for('orders.orders_list') }}" class="btn btn-outline-secondary mb-2">
                <i class="bi bi-arrow-left"></i> Powrot do listy
            </a>
            <h2>
                Zamowienie #{{ order.order_id }}
                <span class="badge {{ current_status.status_class }} fs-6">{{ current_status.status_text }}</span>
                {% if return_info %}
                <span class="badge bg-danger fs-6 ms-1">
                    <i class="bi bi-arrow-return-left"></i> ZWROT
                </span>
                {% endif %}
            </h2>
            {% if order.platform %}
            <span class="badge bg-secondary">{{ order.platform }}</span>
            {% endif %}
            {% if date_add %}
            <span class="text-muted ms-2">{{ date_add | format_dt }}</span>
            {% endif %}
        </div>
    </div>

    <div class="row">
        {# Left column - Order info #}
        <div class="col-lg-8">
            {# Customer & Contact #}
            <div class="card mb-3">
                <div class="card-header">
                    <i class="bi bi-person"></i> Dane klienta
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-muted">Kontakt</h6>
                            <p class="mb-1">
                                <strong>{{ order.customer_name or order.delivery_fullname or '-' }}</strong>
                            </p>
                            {% if order.email %}
                            <p class="mb-1">
                                <i class="bi bi-envelope"></i> 
                                <a href="mailto:{{ order.email }}">{{ order.email }}</a>
                            </p>
                            {% endif %}
                            {% if order.phone %}
                            <p class="mb-1">
                                <i class="bi bi-telephone"></i> 
                                <a href="tel:{{ order.phone }}">{{ order.phone }}</a>
                            </p>
                            {% endif %}
                            {% if order.user_login %}
                            <p class="mb-0">
                                <i class="bi bi-person-badge"></i> 
                                Login: {{ order.user_login }}
                            </p>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-muted">Adres dostawy</h6>
                            {% if order.delivery_point_name %}
                            {# Paczkomat/punkt odbioru #}
                            <p class="mb-1">
                                <span class="badge bg-info">Punkt odbioru</span>
                            </p>
                            <p class="mb-1">
                                <strong>{{ order.delivery_point_name }}</strong>
                            </p>
                            <p class="mb-1">
                                {{ order.delivery_point_address }}
                            </p>
                            <p class="mb-0">
                                {{ order.delivery_point_postcode }} {{ order.delivery_point_city }}
                            </p>
                            {% else %}
                            {# Adres domowy #}
                            <p class="mb-1">{{ order.delivery_fullname or '-' }}</p>
                            {% if order.delivery_company %}
                            <p class="mb-1">{{ order.delivery_company }}</p>
                            {% endif %}
                            <p class="mb-1">{{ order.delivery_address or '-' }}</p>
                            <p class="mb-0">
                                {{ order.delivery_postcode or '' }} {{ order.delivery_city or '' }}
                                {% if order.delivery_country and order.delivery_country != 'Polska' %}
                                , {{ order.delivery_country }}
                                {% endif %}
                            </p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            {# Invoice data (if requested) #}
            {% if order.want_invoice %}
            <div class="card mb-3">
                <div class="card-header">
                    <i class="bi bi-receipt"></i> Dane do faktury
                </div>
                <div class="card-body">
                    <p class="mb-1"><strong>{{ order.invoice_fullname or order.invoice_company or '-' }}</strong></p>
                    {% if order.invoice_company %}
                    <p class="mb-1">{{ order.invoice_company }}</p>
                    {% endif %}
                    {% if order.invoice_nip %}
                    <p class="mb-1">NIP: {{ order.invoice_nip }}</p>
                    {% endif %}
                    <p class="mb-1">{{ order.invoice_address or '-' }}</p>
                    <p class="mb-0">{{ order.invoice_postcode or '' }} {{ order.invoice_city or '' }}</p>
                </div>
            </div>
            {% endif %}

            {# Products #}
            <div class="card mb-3">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-box"></i> Produkty</span>
                    <span class="badge bg-primary">{{ products|length }} szt.</span>
                </div>
                <div class="card-body p-0">
                    <table class="table table-striped mb-0">
                        <thead>
                            <tr>
                                <th>Produkt</th>
                                <th>EAN</th>
                                <th class="text-center">Ilość</th>
                                <th class="text-end">Cena</th>
                            </tr>
                        </thead>
                        <tbody>
                        {% for product in products %}
                            <tr>
                                <td>
                                    {% if product.warehouse_product %}
                                    <a href="{{ url_for('products.product_detail', product_id=product.warehouse_product.id) }}" class="text-decoration-none">
                                        <strong>{{ product.name or '-' }}</strong>
                                        <span class="badge bg-success ms-1">{{ product.warehouse_product.quantity_in_stock }} szt.</span>
                                    </a>
                                    {% else %}
                                    <strong>{{ product.name or '-' }}</strong>
                                    {% if product.ean %}
                                    <span class="badge bg-warning text-dark ms-1" title="Brak powiązania z magazynem">
                                        <i class="bi bi-exclamation-triangle"></i>
                                    </span>
                                    {% endif %}
                                    {% endif %}
                                    {% if product.attributes %}
                                    <br><small class="text-muted">{{ product.attributes }}</small>
                                    {% endif %}
                                    {% if product.sku %}
                                    <br><small class="text-muted">SKU: {{ product.sku }}</small>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if product.ean %}
                                    <code>{{ product.ean }}</code>
                                    {% else %}
                                    <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td class="text-center">{{ product.quantity }}</td>
                                <td class="text-end">
                                    {% if product.price_brutto %}
                                    {{ '%.2f'|format(product.price_brutto) }}
                                    {% else %}
                                    -
                                    {% endif %}
                                </td>
                            </tr>
                        {% else %}
                            <tr>
                                <td colspan="4" class="text-center text-muted">Brak produktów</td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            {# Comments #}
            {% if order.user_comments or order.admin_comments %}
            <div class="card mb-3">
                <div class="card-header">
                    <i class="bi bi-chat-text"></i> Komentarze
                </div>
                <div class="card-body">
                    {% if order.user_comments %}
                    <div class="mb-3">
                        <h6 class="text-muted">Komentarz kupującego:</h6>
                        <p class="mb-0">{{ order.user_comments }}</p>
                    </div>
                    {% endif %}
                    {% if order.admin_comments %}
                    <div>
                        <h6 class="text-muted">Notatki sprzedawcy:</h6>
                        <p class="mb-0">{{ order.admin_comments }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>

        {# Right column - shipping, payment #}
        <div class="col-lg-4">
            {# Shipping info with Timeline #}
            <div class="card mb-3">
                <div class="card-header">
                    <i class="bi bi-truck"></i> Wysylka
                </div>
                <div class="card-body">
                    {% if return_info %}
                    {# === SEKCJA ZWROTU === #}
                    <div class="return-section mb-4">
                        <div class="alert alert-danger mb-3">
                            <h6 class="mb-2"><i class="bi bi-arrow-return-left"></i> Zwrot w toku</h6>
                            <p class="mb-1"><strong>Status:</strong> {{ return_info.status_text }}</p>
                            {% if return_info.return_tracking_number %}
                            <p class="mb-1"><strong>Nr sledzenia:</strong> <code>{{ return_info.return_tracking_number }}</code></p>
                            {% endif %}
                            {% if return_info.notes %}
                            <p class="mb-0"><small>{{ return_info.notes }}</small></p>
                            {% endif %}
                        </div>
                        
                        {# Timeline zwrotu #}
                        <h6 class="text-muted mb-3">Przebieg zwrotu</h6>
                        <div class="shipping-timeline mb-3">
                            <div class="timeline-track">
                                {% for stage_key, stage_label, stage_icon, stage_desc in return_stages %}
                                {% set is_completed = loop.index0 <= return_stage_index %}
                                {% set is_current = loop.index0 == return_stage_index %}
                                <div class="timeline-step return-step {% if is_completed %}completed{% endif %} {% if is_current %}current{% endif %}" 
                                     style="animation-delay: {{ loop.index0 * 0.1 }}s">
                                    <div class="step-marker return-marker">
                                        <i class="bi bi-{{ stage_icon }}"></i>
                                    </div>
                                    <span class="step-label">{{ stage_label }}</span>
                                </div>
                                {% if not loop.last %}
                                <div class="timeline-connector return-connector {% if loop.index0 < return_stage_index %}completed{% endif %}"></div>
                                {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                        
                        {# Informacje o zwroconych produktach #}
                        {% if return_info.return_items %}
                        <div class="return-items mb-3">
                            <h6 class="text-muted">Zwracane produkty:</h6>
                            <ul class="list-unstyled mb-0">
                                {% for item in return_info.return_items %}
                                <li><i class="bi bi-box"></i> {{ item.name }} x{{ item.quantity }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                        {% endif %}
                        
                        {# Status przywrocenia stanu #}
                        <div class="d-flex gap-2 align-items-center flex-wrap">
                            {% if return_info.messenger_notified %}
                            <span class="badge bg-success"><i class="bi bi-check"></i> Powiadomienie wyslane</span>
                            {% else %}
                            <span class="badge bg-warning text-dark"><i class="bi bi-hourglass"></i> Oczekuje na powiadomienie</span>
                            {% endif %}
                            {% if return_info.stock_restored %}
                            <span class="badge bg-success"><i class="bi bi-check"></i> Stan przywrocony</span>
                            {% else %}
                            <span class="badge bg-secondary"><i class="bi bi-hourglass"></i> Stan do przywrocenia</span>
                            <form action="{{ url_for('orders.restore_return_stock', order_id=order.order_id) }}" method="POST" class="d-inline ms-2">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <button type="submit" class="btn btn-sm btn-outline-success" onclick="return confirm('Przywrocic stan magazynowy dla tego zwrotu?')">
                                    <i class="bi bi-arrow-counterclockwise"></i> Przywroc stan
                                </button>
                            </form>
                            {% endif %}
                        </div>
                        
                        {# Przycisk zwrotu pieniedzy - tylko dla statusu delivered/in_transit i gdy mamy allegro_return_id #}
                        {% if return_info.status in ['delivered', 'in_transit'] and return_info.allegro_return_id %}
                        <div class="mt-3 pt-3 border-top">
                            <h6 class="text-danger mb-2"><i class="bi bi-cash-coin"></i> Zwrot pieniedzy</h6>
                            <button type="button" class="btn btn-danger btn-sm" id="refundBtn"
                                    data-bs-toggle="modal" data-bs-target="#refundModal">
                                <i class="bi bi-currency-exchange"></i> Zwroc pieniadze klientowi
                            </button>
                            <small class="d-block text-muted mt-1">
                                Ta operacja jest NIEODWRACALNA. Upewnij sie, ze paczka dotarla i produkty sa sprawdzone.
                            </small>
                        </div>
                        {% elif return_info.status == 'completed' %}
                        <div class="mt-3 pt-3 border-top">
                            <span class="badge bg-success"><i class="bi bi-check-circle"></i> Pieniadze zostaly zwrocone</span>
                        </div>
                        {% endif %}
                    </div>
                    
                    <hr class="my-3">
                    
                    {# Zwinieta historia wysylki do klienta #}
                    <details class="mb-3">
                        <summary class="text-muted cursor-pointer">
                            <i class="bi bi-clock-history"></i> Historia wysylki do klienta (przed zwrotem)
                        </summary>
                        <div class="mt-3">
                            <div class="shipping-timeline opacity-50">
                                <div class="timeline-track">
                                    {% for stage_key, stage_label, stage_icon, stage_desc in shipping_stages %}
                                    {% set is_completed = loop.index0 <= current_stage_index %}
                                    {% set is_current = loop.index0 == current_stage_index %}
                                    <div class="timeline-step {% if is_completed %}completed{% endif %} {% if is_current %}current{% endif %}" 
                                         style="animation-delay: {{ loop.index0 * 0.1 }}s">
                                        <div class="step-marker">
                                            <i class="bi bi-{{ stage_icon }}"></i>
                                        </div>
                                        <span class="step-label">{{ stage_label }}</span>
                                    </div>
                                    {% if not loop.last %}
                                    <div class="timeline-connector {% if loop.index0 < current_stage_index %}completed{% endif %}"></div>
                                    {% endif %}
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </details>
                    {% else %}
                    {# === NORMALNA SEKCJA WYSYLKI (bez zwrotu) === #}
                    {# Animowany Timeline #}
                    <div class="shipping-timeline mb-4">
                        <div class="timeline-track">
                            {% for stage_key, stage_label, stage_icon, stage_desc in shipping_stages %}
                            {% set is_completed = loop.index0 <= current_stage_index %}
                            {% set is_current = loop.index0 == current_stage_index %}
                            <div class="timeline-step {% if is_completed %}completed{% endif %} {% if is_current %}current{% endif %}" 
                                 style="animation-delay: {{ loop.index0 * 0.1 }}s">
                                <div class="step-marker">
                                    <i class="bi bi-{{ stage_icon }}"></i>
                                </div>
                                <span class="step-label">{{ stage_label }}</span>
                            </div>
                            {% if not loop.last %}
                            <div class="timeline-connector {% if loop.index0 < current_stage_index %}completed{% endif %}"></div>
                            {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                    
                    <hr class="my-3">
                    {% endif %}
                    
                    <p class="mb-2">
                        <strong>Metoda:</strong> {{ order.delivery_method or '-' }}
                    </p>
                    {% if order.delivery_package_nr %}
                    <p class="mb-2">
                        <strong>Nr przesyłki:</strong> 
                        {% if tracking_url %}
                        <a href="{{ tracking_url }}" target="_blank" class="text-decoration-none">
                            <code>{{ order.delivery_package_nr }}</code>
                            <i class="bi bi-box-arrow-up-right ms-1"></i>
                        </a>
                        {% else %}
                        <code>{{ order.delivery_package_nr }}</code>
                        {% endif %}
                    </p>
                    {% endif %}
                    <div class="d-flex gap-2 mt-3">
                        <form action="{{ url_for('orders.reprint_label', order_id=order.order_id) }}" method="post" class="mb-0">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <button type="submit" class="btn btn-sm btn-outline-primary"
                                    onclick="return confirm('Wydrukować etykietę?');">
                                <i class="bi bi-printer"></i> Drukuj
                            </button>
                        </form>
                        <form action="{{ url_for('orders.download_label', order_id=order.order_id) }}" method="get" class="mb-0">
                            <button type="submit" class="btn btn-sm btn-outline-primary">
                                <i class="bi bi-download"></i> Pobierz
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            {# Payment info #}
            <div class="card mb-3">
                <div class="card-header">
                    <i class="bi bi-credit-card"></i> Płatność i Zysk
                </div>
                <div class="card-body">
                    <p class="mb-2">
                        <strong>Metoda:</strong> {{ order.payment_method or '-' }}
                        {% if order.payment_method_cod %}
                        <span class="badge bg-warning text-dark">Pobranie</span>
                        {% endif %}
                    </p>
                    <p class="mb-2">
                        <strong>Zapłacono:</strong> 
                        {% if order.payment_done %}
                        <span class="text-success fw-bold">
                            {{ '%.2f'|format(order.payment_done) }} {{ order.currency or 'PLN' }}
                        </span>
                        {% else %}
                        <span class="text-danger">Nie opłacono</span>
                        {% endif %}
                    </p>
                    <hr>
                    <h6 class="text-muted mb-2">
                        Koszty Allegro:
                        {% if billing_data_available %}
                        <span class="badge bg-success small">Dane z API</span>
                        {% else %}
                        <span class="badge bg-warning text-dark small">Szacunkowo</span>
                        {% endif %}
                    </h6>
                    
                    {% if billing_data_available %}
                        {# Rzeczywiste dane z Billing API - szczegolowa lista oplat #}
                        {% if fee_details %}
                            {% for fee in fee_details %}
                            <p class="mb-1 small">
                                <strong>{{ fee.name }}:</strong> 
                                <span class="{% if fee.is_estimate %}text-warning{% else %}text-danger{% endif %}">
                                    -{{ '%.2f'|format(fee.amount) }} {{ order.currency or 'PLN' }}
                                    {% if fee.is_estimate %}<i class="bi bi-calculator ms-1" title="Szacowany koszt"></i>{% endif %}
                                </span>
                            </p>
                            {% endfor %}
                        {% else %}
                            {# Fallback na zagregowane kategorie jesli brak fee_details #}
                            {% if allegro_commission > 0 %}
                            <p class="mb-1 small">
                                <strong>Prowizja od sprzedazy:</strong> 
                                <span class="text-danger">-{{ '%.2f'|format(allegro_commission) }} {{ order.currency or 'PLN' }}</span>
                            </p>
                            {% endif %}
                            {% if listing_fee > 0 %}
                            <p class="mb-1 small">
                                <strong>Oplata za wystawienie:</strong> 
                                <span class="text-danger">-{{ '%.2f'|format(listing_fee) }} {{ order.currency or 'PLN' }}</span>
                            </p>
                            {% endif %}
                            {% if promo_fee > 0 %}
                            <p class="mb-1 small">
                                <strong>Oplaty promocyjne:</strong> 
                                <span class="text-danger">-{{ '%.2f'|format(promo_fee) }} {{ order.currency or 'PLN' }}</span>
                            </p>
                            {% endif %}
                            {% if other_fees > 0 %}
                            <p class="mb-1 small">
                                <strong>Inne oplaty:</strong> 
                                <span class="text-danger">-{{ '%.2f'|format(other_fees) }} {{ order.currency or 'PLN' }}</span>
                            </p>
                            {% endif %}
                        {% endif %}
                        
                        <p class="mb-1 small fw-bold">
                            <strong>Suma oplat Allegro:</strong> 
                            <span class="text-danger">-{{ '%.2f'|format(total_allegro_fees) }} {{ order.currency or 'PLN' }}</span>
                        </p>
                    {% else %}
                        {# Szacunkowe dane (brak API) #}
                        <p class="mb-1 small">
                            <strong>Marza Allegro (~12.3%):</strong> 
                            <span class="text-danger">-{{ '%.2f'|format(allegro_commission) }} {{ order.currency or 'PLN' }}</span>
                        </p>
                    {% endif %}
                    
                    {% if purchase_cost > 0 %}
                    <p class="mb-1 small">
                        <strong>Koszt zakupu:</strong> 
                        <span class="text-danger">-{{ '%.2f'|format(purchase_cost) }} {{ order.currency or 'PLN' }}</span>
                    </p>
                    {% endif %}
                    {% if packaging_cost > 0 %}
                    <p class="mb-2 small">
                        <strong>Koszt pakowania:</strong> 
                        <span class="text-danger">-{{ '%.2f'|format(packaging_cost) }} {{ order.currency or 'PLN' }}</span>
                    </p>
                    {% endif %}
                    <hr>
                    <p class="mb-0">
                        <strong>Realny zysk:</strong> 
                        <span class="{% if real_profit >= 0 %}text-success{% else %}text-danger{% endif %} fw-bold fs-5">
                            {{ '%.2f'|format(real_profit) }} {{ order.currency or 'PLN' }}
                        </span>
                    </p>
                </div>
            </div>

            {# Return status history (if return exists) #}
            {% if return_info and return_status_history %}
            <div class="card mb-3 border-danger">
                <div class="card-header bg-danger text-white">
                    <i class="bi bi-arrow-return-left"></i> Historia zwrotu
                </div>
                <div class="card-body p-0">
                    <ul class="list-group list-group-flush">
                    {% for log in return_status_history %}
                        <li class="list-group-item">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <span class="badge {{ log.status_class }}">{{ log.status_text }}</span>
                                    {% if log.notes %}
                                    <br><small class="text-muted">{{ log.notes }}</small>
                                    {% endif %}
                                </div>
                                <small class="text-muted">{{ log.timestamp | format_dt }}</small>
                            </div>
                        </li>
                    {% endfor %}
                    </ul>
                </div>
            </div>
            {% endif %}

            {# Status history #}
            {% if status_history %}
            <div class="card mb-3">
                <div class="card-header">
                    <i class="bi bi-clock-history"></i> Historia statusow{% if return_info %} (wysylka){% endif %}
                </div>
                <div class="card-body p-0">
                    <ul class="list-group list-group-flush">
                    {% for log in status_history %}
                        <li class="list-group-item">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <span class="badge {{ log.status_class }}">{{ log.status_text }}</span>
                                    {% if log.tracking_number %}
                                    <br><small class="text-muted">Nr: {{ log.tracking_number }}</small>
                                    {% endif %}
                                    {% if log.notes %}
                                    <br><small class="text-muted">{{ log.notes }}</small>
                                    {% endif %}
                                </div>
                                <small class="text-muted">{{ log.timestamp | format_dt }}</small>
                            </div>
                        </li>
                    {% endfor %}
                    </ul>
                </div>
            </div>
            {% endif %}

            {# Quick actions #}
            {% if order.external_order_id and order.platform == 'allegro' %}
            <div class="card">
                <div class="card-header">
                    <i class="bi bi-lightning"></i> Szybkie akcje
                </div>
                <div class="card-body">
                    <a href="https://allegro.pl/moje-allegro/sprzedaz/zamowienia/{{ order.external_order_id }}" 
                       target="_blank" class="btn btn-outline-secondary w-100">
                        <i class="bi bi-box-arrow-up-right"></i> Otwórz w Allegro
                    </a>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

{# Style dla timeline wysyłki #}
<style>
.shipping-timeline {
    padding: 10px 0;
}

.timeline-track {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    position: relative;
}

.timeline-step {
    display: flex;
    flex-direction: column;
    align-items: center;
    flex: 0 0 auto;
    z-index: 2;
    opacity: 0;
    transform: translateY(10px);
    animation: fadeInUp 0.4s ease forwards;
}

@keyframes fadeInUp {
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.step-marker {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: #e9ecef;
    border: 3px solid #dee2e6;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #6c757d;
    font-size: 14px;
    transition: all 0.3s ease;
}

.timeline-step.completed .step-marker {
    background: #198754;
    border-color: #198754;
    color: white;
}

.timeline-step.current .step-marker {
    background: #0d6efd;
    border-color: #0d6efd;
    color: white;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% {
        box-shadow: 0 0 0 0 rgba(13, 110, 253, 0.4);
    }
    50% {
        box-shadow: 0 0 0 8px rgba(13, 110, 253, 0);
    }
}

.step-label {
    font-size: 10px;
    color: #6c757d;
    margin-top: 6px;
    text-align: center;
    max-width: 50px;
    line-height: 1.2;
    transition: color 0.3s ease;
}

.timeline-step.completed .step-label,
.timeline-step.current .step-label {
    color: #212529;
    font-weight: 500;
}

.timeline-connector {
    flex: 1;
    height: 3px;
    background: #dee2e6;
    margin-top: 17px;
    margin-left: -2px;
    margin-right: -2px;
    transition: background 0.3s ease;
    z-index: 1;
}

.timeline-connector.completed {
    background: #198754;
}

/* Responsywnosc dla malych ekranow */
@media (max-width: 576px) {
    .timeline-track {
        overflow-x: auto;
        padding-bottom: 10px;
    }
    
    .timeline-step {
        min-width: 45px;
    }
    
    .step-marker {
        width: 28px;
        height: 28px;
        font-size: 11px;
    }
    
    .step-label {
        font-size: 8px;
        max-width: 40px;
    }
    
    .timeline-connector {
        min-width: 10px;
        margin-top: 14px;
    }
}

/* Style dla timeline zwrotu */
.return-step.completed .step-marker.return-marker {
    background: #dc3545;
    border-color: #dc3545;
    color: white;
}

.return-step.current .step-marker.return-marker {
    background: #dc3545;
    border-color: #dc3545;
    color: white;
    animation: pulse-danger 2s infinite;
}

@keyframes pulse-danger {
    0%, 100% {
        box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.4);
    }
    50% {
        box-shadow: 0 0 0 8px rgba(220, 53, 69, 0);
    }
}

.timeline-connector.return-connector.completed {
    background: #dc3545;
}

.return-section {
    border-left: 4px solid #dc3545;
    padding-left: 15px;
}

/* Cursor dla details/summary */
.cursor-pointer {
    cursor: pointer;
}

details summary::-webkit-details-marker {
    display: none;
}

details summary::before {
    content: '+ ';
    font-weight: bold;
}

details[open] summary::before {
    content: '- ';
}
</style>

{# Modal potwierdzenia zwrotu pieniedzy #}
{% if return_info and return_info.status in ['delivered', 'in_transit'] and return_info.allegro_return_id %}
<div class="modal fade" id="refundModal" tabindex="-1" aria-labelledby="refundModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="refundModalLabel">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    Potwierdzenie zwrotu pieniedzy
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Zamknij"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger mb-3">
                    <strong>UWAGA!</strong> Ta operacja jest <strong>NIEODWRACALNA</strong>. 
                    Pieniadze zostana zwrocone klientowi poprzez Allegro.
                </div>
                
                <div id="refundCheckLoading" class="text-center py-3">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Sprawdzanie...</span>
                    </div>
                    <p class="mt-2 mb-0">Sprawdzanie kwalifikowalnosci zwrotu...</p>
                </div>
                
                <div id="refundCheckResult" style="display: none;">
                    <div id="refundEligible" style="display: none;">
                        <h6>Szczegoly zwrotu:</h6>
                        <table class="table table-sm table-bordered">
                            <tr>
                                <td><strong>Kwota do zwrotu:</strong></td>
                                <td id="refundAmount" class="text-success fw-bold"></td>
                            </tr>
                            <tr>
                                <td><strong>W tym koszt dostawy:</strong></td>
                                <td id="refundDelivery"></td>
                            </tr>
                            <tr>
                                <td><strong>Status Allegro:</strong></td>
                                <td id="refundAllegroStatus"></td>
                            </tr>
                        </table>
                        
                        <div class="form-check mt-3">
                            <input class="form-check-input" type="checkbox" id="deliveryCostCovered" checked>
                            <label class="form-check-label" for="deliveryCostCovered">
                                Zwroc takze koszt dostawy
                            </label>
                        </div>
                        
                        <div class="mt-3">
                            <label for="refundReason" class="form-label">Komentarz (opcjonalnie):</label>
                            <textarea class="form-control" id="refundReason" rows="2" maxlength="500" 
                                      placeholder="Np. Towar zwrocony w pelnym stanie"></textarea>
                        </div>
                        
                        <div class="form-check mt-3">
                            <input class="form-check-input" type="checkbox" id="confirmRefund" required>
                            <label class="form-check-label text-danger" for="confirmRefund">
                                <strong>Potwierdzam zwrot pieniedzy klientowi</strong>
                            </label>
                        </div>
                    </div>
                    
                    <div id="refundNotEligible" class="alert alert-warning" style="display: none;">
                        <i class="bi bi-x-circle me-2"></i>
                        <span id="refundNotEligibleReason"></span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Anuluj</button>
                <form id="refundForm" action="{{ url_for('orders.process_refund', order_id=order.order_id) }}" method="POST">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="confirm" value="true">
                    <input type="hidden" name="allegro_return_id" value="{{ return_info.allegro_return_id }}">
                    <input type="hidden" name="delivery_cost_covered" id="deliveryCostCoveredInput" value="true">
                    <input type="hidden" name="reason" id="reasonInput" value="">
                    <button type="submit" class="btn btn-danger" id="confirmRefundBtn" disabled>
                        <i class="bi bi-currency-exchange"></i> Zwroc pieniadze
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    var refundModal = document.getElementById('refundModal');
    if (!refundModal) return;
    
    refundModal.addEventListener('show.bs.modal', function () {
        // Reset stanu
        document.getElementById('refundCheckLoading').style.display = 'block';
        document.getElementById('refundCheckResult').style.display = 'none';
        document.getElementById('refundEligible').style.display = 'none';
        document.getElementById('refundNotEligible').style.display = 'none';
        document.getElementById('confirmRefund').checked = false;
        document.getElementById('confirmRefundBtn').disabled = true;
        
        // Sprawdz kwalifikowalnosc
        fetch('{{ url_for("orders.check_refund_eligibility", order_id=order.order_id) }}')
            .then(response => response.json())
            .then(data => {
                document.getElementById('refundCheckLoading').style.display = 'none';
                document.getElementById('refundCheckResult').style.display = 'block';
                
                if (data.eligible && data.details) {
                    document.getElementById('refundEligible').style.display = 'block';
                    document.getElementById('refundAmount').textContent = 
                        data.details.total_amount.toFixed(2) + ' ' + data.details.currency;
                    document.getElementById('refundDelivery').textContent = 
                        data.details.delivery_amount.toFixed(2) + ' ' + data.details.currency;
                    document.getElementById('refundAllegroStatus').textContent = data.details.allegro_status;
                } else {
                    document.getElementById('refundNotEligible').style.display = 'block';
                    document.getElementById('refundNotEligibleReason').textContent = data.message;
                }
            })
            .catch(error => {
                document.getElementById('refundCheckLoading').style.display = 'none';
                document.getElementById('refundCheckResult').style.display = 'block';
                document.getElementById('refundNotEligible').style.display = 'block';
                document.getElementById('refundNotEligibleReason').textContent = 
                    'Blad sprawdzania: ' + error.message;
            });
    });
    
    // Wlacz przycisk tylko gdy checkbox jest zaznaczony
    document.getElementById('confirmRefund').addEventListener('change', function() {
        document.getElementById('confirmRefundBtn').disabled = !this.checked;
    });
    
    // Aktualizuj hidden inputs przed submitem
    document.getElementById('refundForm').addEventListener('submit', function(e) {
        if (!document.getElementById('confirmRefund').checked) {
            e.preventDefault();
            alert('Musisz potwierdzic operacje!');
            return false;
        }
        
        document.getElementById('deliveryCostCoveredInput').value = 
            document.getElementById('deliveryCostCovered').checked ? 'true' : 'false';
        document.getElementById('reasonInput').value = 
            document.getElementById('refundReason').value;
        
        // Dodatkowe potwierdzenie
        var kwota = document.getElementById('refundAmount').textContent;
        if (!confirm('Czy na pewno chcesz zwrocic ' + kwota + ' klientowi?\n\nTa operacja jest NIEODWRACALNA!')) {
            e.preventDefault();
            return false;
        }
    });
});
</script>
{% endif %}

{% endblock %}
