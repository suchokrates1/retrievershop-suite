{% extends "base.html" %}

{% block content %}
<h2 class="mb-3 text-center">Ustawienia</h2>
{% if db_path_notice %}
<div class="alert alert-warning text-center">
  Sciezka bazy danych jest odczytywana tylko podczas uruchamiania aplikacji.
  Aby zmienic lokalizacje, edytuj plik <code>.env</code> i zrestartuj serwer.
</div>
{% endif %}
<form method="post" id="settingsForm" class="col-md-8 mx-auto">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    
    <div class="accordion" id="settingsAccordion">
    {% for group_name, group_data in grouped_settings.items() %}
        <div class="accordion-item">
            <h2 class="accordion-header">
                <button class="accordion-button {% if not loop.first %}collapsed{% endif %}" type="button" 
                        data-bs-toggle="collapse" data-bs-target="#group-{{ loop.index }}" 
                        aria-expanded="{{ 'true' if loop.first else 'false' }}">
                    <i class="{{ group_data.icon }} me-2"></i>{{ group_name }}
                    <span class="badge bg-secondary ms-2">{{ group_data.entries|length }}</span>
                </button>
            </h2>
            <div id="group-{{ loop.index }}" class="accordion-collapse collapse {% if loop.first %}show{% endif %}" 
                 data-bs-parent="#settingsAccordion">
                <div class="accordion-body p-0">
                    <table class="table table-striped table-hover table-sm mb-0">
                        <tbody>
                        {% for item in group_data.entries %}
                        <tr>
                            <th scope="row" style="width: 40%;">
                                {{ item.label }}
                                {% if item.desc %}<br><small class="text-muted">{{ item.desc }}</small>{% endif %}
                            </th>
                            <td>
                                {% set lower = item.key.lower() %}
                                {% if item.key in boolean_keys %}
                                <select class="form-select form-select-sm" id="{{ item.key }}" name="{{ item.key }}">
                                    <option value="1" {% if item.value|string == '1' %}selected{% endif %}>Tak</option>
                                    <option value="0" {% if item.value|string != '1' %}selected{% endif %}>Nie</option>
                                </select>
                                {% elif 'shipping' in lower or 'commission' in lower %}
                                <input type="number" step="0.01" class="form-control form-control-sm" id="{{ item.key }}" name="{{ item.key }}" value="{{ item.value }}">
                                {% elif item.key == 'LOG_LEVEL' %}
                                <select class="form-select form-select-sm" id="{{ item.key }}" name="{{ item.key }}">
                                    {% for lvl in ['DEBUG','INFO','WARNING','ERROR','CRITICAL'] %}
                                    <option value="{{ lvl }}" {% if item.value == lvl %}selected{% endif %}>{{ lvl }}</option>
                                    {% endfor %}
                                </select>
                                {% elif item.key == 'FLASK_ENV' %}
                                <select class="form-select form-select-sm" id="{{ item.key }}" name="{{ item.key }}">
                                    {% for env in ['production','development'] %}
                                    <option value="{{ env }}" {% if item.value == env %}selected{% endif %}>{{ env }}</option>
                                    {% endfor %}
                                </select>
                                {% else %}
                                {% set is_sensitive =
                                    'password' in lower
                                    or 'secret' in lower
                                    or 'token' in lower
                                    or 'client_secret' in lower
                                    or 'key' in lower
                                %}
                                {% if is_sensitive %}
                                <div class="input-group input-group-sm">
                                    <input type="password" class="form-control" id="{{ item.key }}" name="{{ item.key }}" value="{{ item.value }}">
                                    <span class="input-group-text toggle-password" data-target="{{ item.key }}">
                                        <i class="bi bi-eye"></i>
                                    </span>
                                </div>
                                {% else %}
                                <input type="text" class="form-control form-control-sm" id="{{ item.key }}" name="{{ item.key }}" value="{{ item.value }}">
                                {% endif %}
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    {% endfor %}
    </div>
</form>
<div class="form-actions text-center mt-3">
    <button type="submit" form="settingsForm" class="btn btn-primary">Zapisz</button>
    <form method="post" action="{{ url_for('allegro.authorize') }}" class="d-inline ms-2">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <button type="submit" class="btn btn-outline-secondary">Polacz z Allegro</button>
    </form>
</div>

<hr class="my-4">

{# Sekcja kosztow stalych #}
<div class="card col-md-10 mx-auto mb-4">
    <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="bi bi-cash-stack me-2"></i>Koszty stale (miesieczne)</h5>
        <span class="badge bg-dark">Suma: {{ '%.2f'|format(total_fixed_costs) }} PLN/mies.</span>
    </div>
    <div class="card-body">
        <p class="text-muted small mb-3">
            Koszty stale sa automatycznie odejmowane od miesiecznego zysku na stronie glownej i w raportach.
            Mozesz dodawac rowniez wartosci ujemne (np. dotacje, zwroty).
        </p>
        
        {# Formularz dodawania nowego kosztu #}
        <form method="post" action="{{ url_for('add_fixed_cost') }}" class="row g-2 mb-4 align-items-end">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <div class="col-md-4">
                <label for="new_cost_name" class="form-label small">Nazwa kosztu</label>
                <input type="text" class="form-control form-control-sm" id="new_cost_name" name="name" 
                       placeholder="np. Ksiegowosc, ZUS, Hosting..." required>
            </div>
            <div class="col-md-2">
                <label for="new_cost_amount" class="form-label small">Kwota (PLN)</label>
                <input type="number" step="0.01" class="form-control form-control-sm" id="new_cost_amount" 
                       name="amount" placeholder="0.00" required>
            </div>
            <div class="col-md-4">
                <label for="new_cost_desc" class="form-label small">Opis (opcjonalnie)</label>
                <input type="text" class="form-control form-control-sm" id="new_cost_desc" name="description" 
                       placeholder="Dodatkowe informacje...">
            </div>
            <div class="col-md-2">
                <button type="submit" class="btn btn-success btn-sm w-100">
                    <i class="bi bi-plus-lg"></i> Dodaj
                </button>
            </div>
        </form>
        
        {# Lista kosztow stalych #}
        {% if fixed_costs %}
        <table class="table table-sm table-hover">
            <thead class="table-light">
                <tr>
                    <th>Nazwa</th>
                    <th>Kwota</th>
                    <th>Opis</th>
                    <th>Status</th>
                    <th class="text-end">Akcje</th>
                </tr>
            </thead>
            <tbody>
                {% for cost in fixed_costs %}
                <tr class="{{ 'table-secondary text-muted' if not cost.is_active else '' }}">
                    <td>
                        <strong>{{ cost.name }}</strong>
                    </td>
                    <td>
                        <span class="{{ 'text-danger' if cost.amount > 0 else 'text-success' }}">
                            {{ '%.2f'|format(cost.amount) }} PLN
                        </span>
                    </td>
                    <td class="small text-muted">{{ cost.description or '-' }}</td>
                    <td>
                        {% if cost.is_active %}
                        <span class="badge bg-success">Aktywny</span>
                        {% else %}
                        <span class="badge bg-secondary">Nieaktywny</span>
                        {% endif %}
                    </td>
                    <td class="text-end">
                        {# Przycisk edycji - otwiera modal #}
                        <button type="button" class="btn btn-outline-primary btn-sm" 
                                data-bs-toggle="modal" data-bs-target="#editModal{{ cost.id }}"
                                title="Edytuj">
                            <i class="bi bi-pencil"></i>
                        </button>
                        {# Przycisk wlacz/wylacz #}
                        <form method="post" action="{{ url_for('toggle_fixed_cost', cost_id=cost.id) }}" class="d-inline">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <button type="submit" class="btn btn-outline-{{ 'warning' if cost.is_active else 'success' }} btn-sm"
                                    title="{{ 'Dezaktywuj' if cost.is_active else 'Aktywuj' }}">
                                <i class="bi bi-{{ 'pause' if cost.is_active else 'play' }}"></i>
                            </button>
                        </form>
                        {# Przycisk usun #}
                        <form method="post" action="{{ url_for('delete_fixed_cost', cost_id=cost.id) }}" class="d-inline"
                              onsubmit="return confirm('Na pewno usunac koszt {{ cost.name }}?')">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <button type="submit" class="btn btn-outline-danger btn-sm" title="Usun">
                                <i class="bi bi-trash"></i>
                            </button>
                        </form>
                    </td>
                </tr>
                
                {# Modal edycji #}
                <div class="modal fade" id="editModal{{ cost.id }}" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <form method="post" action="{{ url_for('edit_fixed_cost', cost_id=cost.id) }}">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <div class="modal-header">
                                    <h5 class="modal-title">Edytuj koszt: {{ cost.name }}</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="mb-3">
                                        <label class="form-label">Nazwa</label>
                                        <input type="text" class="form-control" name="name" value="{{ cost.name }}" required>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Kwota (PLN)</label>
                                        <input type="number" step="0.01" class="form-control" name="amount" 
                                               value="{{ cost.amount }}" required>
                                        <small class="text-muted">Wartosc ujemna = przychod/dotacja</small>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Opis</label>
                                        <input type="text" class="form-control" name="description" 
                                               value="{{ cost.description or '' }}">
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Anuluj</button>
                                    <button type="submit" class="btn btn-primary">Zapisz</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="alert alert-info mb-0">
            <i class="bi bi-info-circle me-2"></i>
            Brak zdefiniowanych kosztow stalych. Dodaj pierwsze koszty (np. Ksiegowosc, ZUS, hosting).
        </div>
        {% endif %}
    </div>
</div>

<hr class="my-4">

<div class="card col-md-8 mx-auto">
    <div class="card-header bg-info text-white">
        <h5 class="mb-0">Allegro Scraper - Sprawdzanie cen</h5>
    </div>
    <div class="card-body">
        <p class="card-text">
            Lokalny scraper omija blokady DataDome i szybko sprawdza ceny konkurencji.
        </p>
        
        <div class="alert alert-info">
            <strong>Jak to działa?</strong>
            <ol class="mb-0 mt-2">
                <li>Pobierz scraper i zainstaluj na swoim PC z Windows</li>
                <li>Wpisz adres API scrapera w polu "URL Scrapera Allegro" powyżej</li>
                <li>Kliknij "Monitor cen Allegro" w menu - ceny będą pobierane z Twojego PC!</li>
            </ol>
        </div>
        
        <h6 class="mt-3">Instalacja scrapera (jednorazowo):</h6>
        <ol>
            <li><a href="{{ url_for('main.download_scraper') }}" class="btn btn-sm btn-success">
                <i class="bi bi-download"></i> Pobierz AllegroScraper_Portable.zip
            </a></li>
            <li>Rozpakuj ZIP na swoim PC</li>
            <li>Uruchom <code>SETUP.bat</code> (instaluje Chrome driver)</li>
            <li>Uruchom <code>RUN_SCRAPER.bat</code> (startuje API)</li>
            <li>Zaloguj się na Allegro w oknie Chrome (jednorazowo)</li>
            <li>Wpisz adres w polu powyżej, np: <code>http://192.168.31.150:5555</code></li>
        </ol>
        
        <h6 class="mt-3">Zalety:</h6>
        <ul class="mb-0">
            <li>✅ Brak captcha (używa prawdziwego Chrome z logowaniem)</li>
            <li>✅ Szybkie - 3-5 sekund na ofertę</li>
            <li>✅ Nie blokuje Brave (dedykowany profil Chrome)</li>
            <li>✅ Działa na każdym PC z Windows</li>
            <li>✅ Jeśli scraper nie jest dostępny - automatycznie fallback do wbudowanego Selenium</li>
        </ul>
        
        <small class="text-muted d-block mt-3">
            <strong>Uwaga:</strong> Pozostaw pole "URL Scrapera Allegro" puste aby używać wbudowanego Selenium (wolniejsze, czasem captcha).
        </small>
    </div>
</div>

<script>
    document.querySelectorAll('.toggle-password').forEach(btn => {
        btn.addEventListener('click', () => {
            const input = document.getElementById(btn.dataset.target);
            if (!input) return;
            if (input.type === 'password') {
                input.type = 'text';
                btn.innerHTML = '<i class="bi bi-eye-slash"></i>';
            } else {
                input.type = 'password';
                btn.innerHTML = '<i class="bi bi-eye"></i>';
            }
        });
    });
</script>
{% endblock %}
